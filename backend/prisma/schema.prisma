// TabSync - Prisma Schema
// Restaurant ordering and payment management system
// Multi-tenant SaaS architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - USER & ROLES
// ============================================
enum UserRole {
  SUPER_ADMIN      // Platform owners
  CONSULTANT       // Onboarding consultants
  RESTAURANT_OWNER // Restaurant admin
  WAITER           // Waiter staff
  KITCHEN          // Kitchen staff
  CUSTOMER         // End customer
}

// ============================================
// USERS
// ============================================
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String   @map("full_name")
  phone         String?
  role          UserRole @default(CUSTOMER)
  avatarUrl     String?  @map("avatar_url")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  ownedRestaurants     Restaurant[]
  orderParticipations  OrderParticipant[]
  orderItems           OrderItem[]
  splitPayments        SplitPayment[]
  analyticsEvents      AnalyticsEvent[]
  staffAssignments     Staff[]
  tableSessionMembers  TableSessionMember[]
  reviews              Review[]
  suggestions          Suggestion[]
  complaints           Complaint[]
  npsResponses         NpsResponse[]
  consultant           Consultant?
  auditLogs            AuditLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================
// STAFF - Restaurant Employees
// ============================================
model Staff {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  restaurantId String   @map("restaurant_id")
  role         UserRole // WAITER or KITCHEN
  pin          String?  // Quick access PIN for POS
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@index([userId])
  @@index([isActive])
  @@map("staff")
}

// ============================================
// CONSULTANTS - Onboarding Partners
// ============================================
model Consultant {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  commissionPercent Decimal  @db.Decimal(5, 2) @map("commission_percent")
  totalOnboardings  Int      @default(0) @map("total_onboardings")
  totalEarnings     Decimal  @default(0) @db.Decimal(10, 2) @map("total_earnings")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  onboardedRestaurants ConsultantRestaurant[]

  @@index([isActive])
  @@map("consultants")
}

// Consultant-Restaurant relationship (who onboarded which restaurant)
model ConsultantRestaurant {
  id           String   @id @default(uuid())
  consultantId String   @map("consultant_id")
  restaurantId String   @map("restaurant_id")
  onboardedAt  DateTime @default(now()) @map("onboarded_at")

  // Relations
  consultant Consultant @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([consultantId, restaurantId])
  @@index([consultantId])
  @@index([restaurantId])
  @@map("consultant_restaurants")
}

// ============================================
// RESTAURANTS
// ============================================
model Restaurant {
  id              String   @id @default(uuid())
  ownerId         String   @map("owner_id")
  name            String
  slug            String   @unique
  description     String?  @db.Text
  logoUrl         String?  @map("logo_url")
  coverUrl        String?  @map("cover_url")

  // Address
  addressStreet   String?  @map("address_street")
  addressCity     String?  @map("address_city")
  addressState    String?  @map("address_state")
  addressZip      String?  @map("address_zip")
  addressCountry  String   @default("Brasil") @map("address_country")

  // Contact
  phone           String?
  email           String?

  // Settings
  isActive        Boolean  @default(true) @map("is_active")
  acceptsOrders   Boolean  @default(true) @map("accepts_orders")
  currency        String   @default("BRL")
  operatingHours  Json?    @map("operating_hours")
  timezone        String   @default("America/Sao_Paulo")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  owner              User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  menuCategories     MenuCategory[]
  menuItems          MenuItem[]
  orders             Order[]
  analyticsEvents    AnalyticsEvent[]
  suppliers          Supplier[]
  inventoryItems     InventoryItem[]
  invoiceUploads     InvoiceUpload[]
  stockEntries       StockEntry[]
  staff              Staff[]
  tables             Table[]
  tableSessions      TableSession[]
  subscription       Subscription?
  reviews            Review[]
  suggestions        Suggestion[]
  complaints         Complaint[]
  npsResponses       NpsResponse[]
  consultantOnboard  ConsultantRestaurant[]

  @@index([ownerId])
  @@index([slug])
  @@index([isActive])
  @@map("restaurants")
}

// ============================================
// TABLES - Restaurant Tables
// ============================================
model Table {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  number       Int
  name         String?  // Optional custom name like "Varanda 1"
  qrCode       String   @unique @map("qr_code")
  capacity     Int      @default(4)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  tableSessions TableSession[]

  @@unique([restaurantId, number])
  @@index([restaurantId])
  @@index([qrCode])
  @@index([isActive])
  @@map("tables")
}

// ============================================
// TABLE SESSIONS - Active Table Sessions
// ============================================
enum SessionStatus {
  ACTIVE
  PAYMENT
  CLOSED
}

model TableSession {
  id           String        @id @default(uuid())
  tableId      String        @map("table_id")
  restaurantId String        @map("restaurant_id")
  status       SessionStatus @default(ACTIVE)
  startedAt    DateTime      @default(now()) @map("started_at")
  closedAt     DateTime?     @map("closed_at")

  // Session totals (calculated)
  subtotal     Decimal       @default(0) @db.Decimal(10, 2)
  taxAmount    Decimal       @default(0) @db.Decimal(10, 2) @map("tax_amount")
  totalAmount  Decimal       @default(0) @db.Decimal(10, 2) @map("total_amount")

  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  table       Table                @relation(fields: [tableId], references: [id], onDelete: Cascade)
  restaurant  Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  members     TableSessionMember[]
  orders      Order[]
  reviews     Review[]
  complaints  Complaint[]
  npsResponses NpsResponse[]

  @@index([tableId])
  @@index([restaurantId])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("table_sessions")
}

// ============================================
// TABLE SESSION MEMBERS - People at Table
// ============================================
enum MemberRole {
  OWNER  // Created the session
  MEMBER // Joined the session
}

enum MemberStatus {
  PENDING  // Waiting approval
  APPROVED // Can order
  LEFT     // Left the table
}

enum MemberPaymentStatus {
  PENDING // Has not paid yet
  PAID    // Paid via digital method
  CASH    // Paid in cash
}

model TableSessionMember {
  id            String              @id @default(uuid())
  sessionId     String              @map("session_id")
  userId        String              @map("user_id")
  role          MemberRole          @default(MEMBER)
  status        MemberStatus        @default(PENDING)
  paymentStatus MemberPaymentStatus @default(PENDING) @map("payment_status")
  amountDue     Decimal?            @db.Decimal(10, 2) @map("amount_due")
  amountPaid    Decimal?            @db.Decimal(10, 2) @map("amount_paid")
  exitQrCode    String?             @map("exit_qr_code")
  joinedAt      DateTime            @default(now()) @map("joined_at")
  leftAt        DateTime?           @map("left_at")

  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  // Relations
  session TableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@map("table_session_members")
}

// ============================================
// PLANS - Subscription Plans
// ============================================
model Plan {
  id                 String   @id @default(uuid())
  name               String   // Free, Basic, Pro, Enterprise
  slug               String   @unique
  description        String?  @db.Text
  price              Decimal  @db.Decimal(10, 2)
  billingCycle       String   @default("MONTHLY") @map("billing_cycle") // MONTHLY, YEARLY
  trialDays          Int      @default(14) @map("trial_days")

  // Limits
  maxTables          Int?     @map("max_tables")
  maxMenuItems       Int?     @map("max_menu_items")
  maxStaff           Int?     @map("max_staff")
  maxOrders          Int?     @map("max_orders") // Per month

  // Fees
  platformFeePercent Decimal  @db.Decimal(5, 2) @map("platform_fee_percent")

  // Features (JSON array of feature keys)
  features           Json     // ["split_bill", "ocr_inventory", "analytics", "api_access"]

  isActive           Boolean  @default(true) @map("is_active")
  displayOrder       Int      @default(0) @map("display_order")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions Subscription[]

  @@index([slug])
  @@index([isActive])
  @@map("plans")
}

// ============================================
// SUBSCRIPTIONS - Restaurant Subscriptions
// ============================================
enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

model Subscription {
  id                 String             @id @default(uuid())
  restaurantId       String             @unique @map("restaurant_id")
  planId             String             @map("plan_id")
  status             SubscriptionStatus @default(TRIAL)

  // Trial period
  trialEndsAt        DateTime?          @map("trial_ends_at")

  // Billing period
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")

  // Gateway info
  gatewayCustomerId  String?            @map("gateway_customer_id")
  gatewaySubscriptionId String?         @map("gateway_subscription_id")

  // Cancellation
  cancelledAt        DateTime?          @map("cancelled_at")
  cancellationReason String?            @db.Text @map("cancellation_reason")

  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  plan       Plan       @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

// ============================================
// MENU
// ============================================
model MenuCategory {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String
  description  String?  @db.Text
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems  MenuItem[]

  @@index([restaurantId])
  @@map("menu_categories")
}

model MenuItem {
  id             String   @id @default(uuid())
  restaurantId   String   @map("restaurant_id")
  categoryId     String?  @map("category_id")
  name           String
  description    String?  @db.Text
  imageUrl       String?  @map("image_url")
  price          Decimal  @db.Decimal(10, 2)

  // Nutritional info
  calories       Int?
  allergens      String[]

  // Availability
  isAvailable    Boolean  @default(true) @map("is_available")
  stockQuantity  Int?     @map("stock_quantity")

  // Customizations
  customizations Json?

  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant     Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category       MenuCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  inventoryLinks MenuItemInventory[]

  @@index([restaurantId])
  @@index([categoryId])
  @@index([isAvailable])
  @@map("menu_items")
}

// ============================================
// ORDERS
// ============================================
enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

model Order {
  id              String      @id @default(uuid())
  restaurantId    String      @map("restaurant_id")
  tableSessionId  String?     @map("table_session_id")
  orderNumber     String      @unique @map("order_number")
  tableNumber     String?     @map("table_number")
  status          OrderStatus @default(PENDING)

  // Financial
  subtotal        Decimal     @db.Decimal(10, 2)
  taxAmount       Decimal     @default(0) @db.Decimal(10, 2) @map("tax_amount")
  discountAmount  Decimal     @default(0) @db.Decimal(10, 2) @map("discount_amount")
  totalAmount     Decimal     @db.Decimal(10, 2) @map("total_amount")

  // Split bill feature
  isSplit         Boolean     @default(false) @map("is_split")
  splitCount      Int         @default(1) @map("split_count")

  notes           String?     @db.Text

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  confirmedAt     DateTime?   @map("confirmed_at")
  completedAt     DateTime?   @map("completed_at")
  cancelledAt     DateTime?   @map("cancelled_at")

  // Relations
  restaurant    Restaurant         @relation(fields: [restaurantId], references: [id])
  tableSession  TableSession?      @relation(fields: [tableSessionId], references: [id])
  orderItems    OrderItem[]
  participants  OrderParticipant[]
  payments      Payment[]
  splitPayments SplitPayment[]

  @@index([restaurantId])
  @@index([tableSessionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(uuid())
  orderId        String   @map("order_id")
  menuItemId     String   @map("menu_item_id")
  userId         String?  @map("user_id")
  quantity       Int      @default(1)
  unitPrice      Decimal  @db.Decimal(10, 2) @map("unit_price")
  customizations Json?
  notes          String?  @db.Text

  // Sharing feature
  isShared       Boolean  @default(false) @map("is_shared")
  sharedWith     String[] @map("shared_with")

  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@map("order_items")
}

model OrderParticipant {
  id         String   @id @default(uuid())
  orderId    String   @map("order_id")
  userId     String?  @map("user_id")
  guestName  String?  @map("guest_name")
  guestEmail String?  @map("guest_email")
  role       String   @default("participant")
  joinedAt   DateTime @default(now()) @map("joined_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@map("order_participants")
}

// ============================================
// PAYMENTS
// ============================================
enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  CASH
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id          String        @id @default(uuid())
  orderId     String        @map("order_id")
  method      PaymentMethod @map("payment_method")
  gateway     String?
  gatewayId   String?       @map("gateway_id")
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("BRL")
  status      PaymentStatus @default(PENDING)
  metadata    Json?

  createdAt   DateTime      @default(now()) @map("created_at")
  processedAt DateTime?     @map("processed_at")
  completedAt DateTime?     @map("completed_at")

  // Relations
  order         Order          @relation(fields: [orderId], references: [id])
  splitPayments SplitPayment[]

  @@index([orderId])
  @@index([status])
  @@index([gatewayId])
  @@map("payments")
}

// CORE FEATURE: Split Payments
enum SplitMethod {
  EQUAL
  BY_ITEM
  CUSTOM
  PERCENTAGE
}

enum SplitPaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

model SplitPayment {
  id            String             @id @default(uuid())
  orderId       String             @map("order_id")
  userId        String             @map("user_id")
  userEmail     String             @map("user_email")
  userName      String?            @map("user_name")
  splitMethod   SplitMethod        @map("split_method")
  amountDue     Decimal            @db.Decimal(10, 2) @map("amount_due")
  paymentStatus SplitPaymentStatus @default(PENDING) @map("payment_status")
  paymentId     String?            @map("payment_id")
  paymentLink   String?            @map("payment_link") @db.Text
  paymentToken  String?            @unique @map("payment_token")

  createdAt     DateTime           @default(now()) @map("created_at")
  paidAt        DateTime?          @map("paid_at")
  expiresAt     DateTime?          @map("expires_at")

  // Relations
  order   Order    @relation(fields: [orderId], references: [id])
  user    User     @relation(fields: [userId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([paymentStatus])
  @@map("split_payments")
}

// ============================================
// REVIEWS - Customer Reviews
// ============================================
model Review {
  id              String        @id @default(uuid())
  restaurantId    String        @map("restaurant_id")
  userId          String        @map("user_id")
  tableSessionId  String?       @map("table_session_id")

  // Ratings (1-5 scale)
  overallRating   Int           @map("overall_rating")
  foodRating      Int?          @map("food_rating")
  serviceRating   Int?          @map("service_rating")
  ambianceRating  Int?          @map("ambiance_rating")
  waitTimeRating  Int?          @map("wait_time_rating")
  valueRating     Int?          @map("value_rating")

  comment         String?       @db.Text
  response        String?       @db.Text // Restaurant response
  respondedAt     DateTime?     @map("responded_at")

  isPublic        Boolean       @default(true) @map("is_public")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tableSession TableSession? @relation(fields: [tableSessionId], references: [id])

  @@unique([restaurantId, userId, tableSessionId])
  @@index([restaurantId])
  @@index([userId])
  @@index([tableSessionId])
  @@index([overallRating])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

// ============================================
// SUGGESTIONS - Customer Suggestions
// ============================================
enum SuggestionCategory {
  MENU
  SERVICE
  AMBIANCE
  OTHER
}

enum SuggestionStatus {
  UNREAD
  READ
  RESPONDED
}

model Suggestion {
  id           String             @id @default(uuid())
  restaurantId String             @map("restaurant_id")
  userId       String?            @map("user_id")
  category     SuggestionCategory
  content      String             @db.Text
  isAnonymous  Boolean            @default(false) @map("is_anonymous")
  status       SuggestionStatus   @default(UNREAD)
  response     String?            @db.Text
  respondedAt  DateTime?          @map("responded_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id])

  @@index([restaurantId])
  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("suggestions")
}

// ============================================
// COMPLAINTS - Customer Complaints
// ============================================
enum ComplaintCategory {
  FOOD_QUALITY
  SERVICE
  WAIT_TIME
  BILLING
  HYGIENE
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ESCALATED
  CLOSED
}

model Complaint {
  id               String            @id @default(uuid())
  restaurantId     String            @map("restaurant_id")
  userId           String            @map("user_id")
  tableSessionId   String?           @map("table_session_id")
  category         ComplaintCategory
  priority         Priority          @default(MEDIUM)
  status           ComplaintStatus   @default(OPEN)
  subject          String
  description      String            @db.Text
  escalatedToSuper Boolean           @default(false) @map("escalated_to_super")
  response         String?           @db.Text
  respondedAt      DateTime?         @map("responded_at")
  resolvedAt       DateTime?         @map("resolved_at")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tableSession TableSession? @relation(fields: [tableSessionId], references: [id])

  @@index([restaurantId])
  @@index([userId])
  @@index([tableSessionId])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([escalatedToSuper])
  @@index([createdAt(sort: Desc)])
  @@map("complaints")
}

// ============================================
// NPS RESPONSES - Net Promoter Score
// ============================================
model NpsResponse {
  id             String        @id @default(uuid())
  restaurantId   String        @map("restaurant_id")
  userId         String        @map("user_id")
  tableSessionId String?       @map("table_session_id")
  score          Int           // 0-10
  feedback       String?       @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")

  // Relations
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tableSession TableSession? @relation(fields: [tableSessionId], references: [id])

  @@index([restaurantId])
  @@index([userId])
  @@index([tableSessionId])
  @@index([score])
  @@index([createdAt(sort: Desc)])
  @@map("nps_responses")
}

// ============================================
// ANALYTICS
// ============================================
model AnalyticsEvent {
  id           String   @id @default(uuid())
  restaurantId String?  @map("restaurant_id")
  userId       String?  @map("user_id")
  eventType    String   @map("event_type")
  eventData    Json?    @map("event_data")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  restaurant Restaurant? @relation(fields: [restaurantId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])

  @@index([restaurantId])
  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@map("analytics_events")
}

// ============================================
// AUDIT LOG - LGPD/Compliance
// ============================================
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String   // LOGIN, LOGOUT, CREATE_ORDER, PROCESS_PAYMENT, etc.
  entityType  String?  @map("entity_type")  // User, Order, Payment, etc.
  entityId    String?  @map("entity_id")
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ============================================
// INVENTORY & STOCK MANAGEMENT
// ============================================

// Supplier/Fornecedor
model Supplier {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String
  cnpj         String?  @unique
  email        String?
  phone        String?
  address      String?  @db.Text
  notes        String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant   Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  stockEntries StockEntry[]
  invoices     InvoiceUpload[]

  @@index([restaurantId])
  @@index([isActive])
  @@map("suppliers")
}

// Inventory Item (Produto no Estoque)
model InventoryItem {
  id                String   @id @default(uuid())
  restaurantId      String   @map("restaurant_id")
  name              String
  description       String?  @db.Text
  sku               String?  @unique
  unit              String   @default("UN") // UN, KG, L, etc.

  // Stock
  currentStock      Decimal  @default(0) @db.Decimal(10, 3) @map("current_stock")
  minimumStock      Decimal  @default(0) @db.Decimal(10, 3) @map("minimum_stock")

  // Pricing
  lastPurchasePrice Decimal? @db.Decimal(10, 2) @map("last_purchase_price")
  averagePrice      Decimal? @db.Decimal(10, 2) @map("average_price")

  // Settings
  trackStock        Boolean  @default(true) @map("track_stock")
  isActive          Boolean  @default(true) @map("is_active")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant   Restaurant            @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  stockEntries StockEntryItem[]
  menuItems    MenuItemInventory[]

  @@index([restaurantId])
  @@index([isActive])
  @@index([currentStock])
  @@map("inventory_items")
}

// Relation Many-to-Many entre MenuItem e InventoryItem
model MenuItemInventory {
  id              String   @id @default(uuid())
  menuItemId      String   @map("menu_item_id")
  inventoryItemId String   @map("inventory_item_id")
  quantity        Decimal  @db.Decimal(10, 3) // Quantidade usada do estoque por item do menu
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, inventoryItemId])
  @@index([menuItemId])
  @@index([inventoryItemId])
  @@map("menu_item_inventory")
}

// Invoice Upload (Nota Fiscal Upload)
enum InvoiceStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  ERROR
  CANCELLED
}

model InvoiceUpload {
  id            String        @id @default(uuid())
  restaurantId  String        @map("restaurant_id")
  supplierId    String?       @map("supplier_id")

  // File info
  fileName      String        @map("file_name")
  fileUrl       String        @map("file_url") @db.Text
  fileType      String        @map("file_type") // jpeg, png, pdf
  fileSize      Int           @map("file_size")

  // Invoice data
  invoiceNumber String?       @map("invoice_number")
  invoiceDate   DateTime?     @map("invoice_date")
  totalAmount   Decimal?      @db.Decimal(10, 2) @map("total_amount")

  // OCR/Processing
  status        InvoiceStatus @default(UPLOADED)
  ocrData       Json?         @map("ocr_data")
  extractedData Json?         @map("extracted_data")
  errorMessage  String?       @db.Text @map("error_message")

  // Confirmation
  isConfirmed   Boolean       @default(false) @map("is_confirmed")
  confirmedAt   DateTime?     @map("confirmed_at")

  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  restaurant   Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  supplier     Supplier?    @relation(fields: [supplierId], references: [id])
  stockEntry   StockEntry?

  @@index([restaurantId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("invoice_uploads")
}

// Stock Entry (Entrada de Estoque)
enum StockEntryType {
  PURCHASE      // Compra
  ADJUSTMENT    // Ajuste
  RETURN        // Devolucao
  LOSS          // Perda/Quebra
  TRANSFER      // Transferencia
}

model StockEntry {
  id             String         @id @default(uuid())
  restaurantId   String         @map("restaurant_id")
  supplierId     String?        @map("supplier_id")
  invoiceId      String?        @unique @map("invoice_id")

  type           StockEntryType @default(PURCHASE)
  referenceNumber String?       @map("reference_number")
  notes          String?        @db.Text
  totalAmount    Decimal?       @db.Decimal(10, 2) @map("total_amount")

  createdAt      DateTime       @default(now()) @map("created_at")
  createdBy      String?        @map("created_by")

  // Relations
  restaurant Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  supplier   Supplier?        @relation(fields: [supplierId], references: [id])
  invoice    InvoiceUpload?   @relation(fields: [invoiceId], references: [id])
  items      StockEntryItem[]

  @@index([restaurantId])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("stock_entries")
}

// Stock Entry Item (Itens da Entrada)
model StockEntryItem {
  id              String   @id @default(uuid())
  stockEntryId    String   @map("stock_entry_id")
  inventoryItemId String   @map("inventory_item_id")

  quantity        Decimal  @db.Decimal(10, 3)
  unitPrice       Decimal  @db.Decimal(10, 2) @map("unit_price")
  totalPrice      Decimal  @db.Decimal(10, 2) @map("total_price")

  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  stockEntry    StockEntry    @relation(fields: [stockEntryId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([stockEntryId])
  @@index([inventoryItemId])
  @@map("stock_entry_items")
}
